sudo: required
language: csharp
mono: none
dotnet: 2.1.300
env:
  global:
  # ConnectionString
  - secure: lZnvYlQUl07lXzS5FfUCgnkidJG7xncGguMnaSMJXb5c+fmnuqCi4Kb5faR5k82EtDdYFUzusFVoTXCYmLzQWZx6znFEfEU7u6pW/MjIYt/dbV9A5JXqus/qLXM8nKj3UUo6/Bpji+1YH1bUjcUnqyDM078eBzuh8wETUUB5oTrpnDdtIbjohJHFbpSs68spF+7wMkBebca8/CG4ujnRokqtDqj2xRu2BdvQyLsfnq7Skzu96XIFUkzf1ho0Mj7QN5BAFS51OXw85v2YYs0qgTKp0taca9vm+Gx97agxPUUdWUBl4wYD1wakr7iHYmPI00RB0oX5lTaa+JhtOxVH/xW5XIp/eU8yXAyKkIyX/OLFrNvyQ4mYT7tNet3uKw7iWFTafD6/FjmwdVIW7J9Tm7qNLjP775bmIOyMV+f6ATLO4aXJ5KP5pnsqZsPrwzIvSOWHF+fIhrbef0cTCr8DX/MTByA+12MHwY0CXNUpU5xR8SVCQ1ymENq3Jq79wUVq+cuz7SAs/icfhqns5G3aaQWlaKGddKP9+Hwc+4mHM0CbMYH7SU306G93ax7UFxztXpo2d5ZYlAuG3XPzxDbdFMLqKlIySBvOoFDawyVUs/bGwLEAHJdPud9++Sz2/t0Kn8W49f+78vLsSjRXT2FYZ38xNP+c32JCK+FZEIZVSh8=
  # DeployUser
  - secure: nxwFVSuA4n6UzNO2kICwMdRBA62iZE681nc5nrhjoBV1mbObCl8z7pSHkGcRVym4IPJXVvm+QCbNn+qLdbHQNHmYaxBQdXDMhfQjjlHpUfofiWDJmZsNJsAFRR/l0kGmEIR3CvkaLs0EiClguAT6Wj8iuzQVYeeG0yFLbYae01e90XQe4V3SowHxADmRUlmqmOGAMLjVpoN1BJmlSAGyHONkMhGir8V7/1uNP4Qa1PenyZBsWywRiHAELXHh1k9RJXiKC0nXRFSK16SfR1+nqNqUBc6ZKNkzfkaNvaEdH5yRxzk4Gd+0J9ZCNiXLfhGpElgCgGQIbsJDkMx9FfSP0gl/gabku2g1EJC0pfw/U8rM1uc+qccEBtfuLkkuO48Jem6A0uZlcnGKCPT1rnrWAwK5aURmCCIzNAzo0qTS9IX7V22UAFuCedfS3Tyao+CMmeKvqTZcZ4lYifBz5uQbRO5z5GS47pDerjp4HydyurqreZYfQJuwWiwR0UJVthvWi+1n2piouZikiYOrRK+hYpW5e+HvzAn+KU8zUbNcBO/ExsCYdybgCInm4G+JWjjEbroAHl0FeZbOy09Kjcci6R2gMZxmkI3VcxQHxAvNqgAGPlzPL0lag0HZIephAftqqkImlEpnl8llO6eF11gsgHeaGP+PUoYu64DXeR7W0+I=
  # DeployServer
  - secure: oHoqq2uQq4TE89/wTBE7EU6brKy/OhKl9UjeeD60Lr4ldhFxlVzVub6lQKhm1TGGpLRbomc6aJtzcVLSzkEYXZuUEEREKbp4tyZQxmUuvMAs+OqNb6L+mUxxyECmTf6L5IIeNOWAJDJv34NMivwg80ykLHpXTB84ZPmyGDFq1hCHw8mD38v+U+WZz1cpO+go7cM1o3tneNwR4L068ZH6o33QBsTHi6E7c8TGUZ3qUR3fGSzuQaSzRfHuc/HUK+tIJt2SmQN5C5e3pUM9/CJ01GdCOjfVkwXchR7IMrg3hj4bR904yZRR05zftIgFaZiB7vmmI02E3PSr57WZvBoJJmJ9wjrLJOcmWlQBxCCkbNrpnqrm15H4ap8tGe2gRgowLU2wqKpBO3b6jOaA5+beu+rZUphoTWRVhFmoFDhyvaLURscilzFrdKeaUOnZxDFexKPTIDmABvzdf+JgwoVaEj5mhNZlWjpopkRo9LauUnIuUC+3Hh53xglK/TehIbPKRLCCCwnBfPgZdbciARvLyAgUDQFIPThZUWEXOwgAmL1jK7PRJeXOVF611OoQjlHyxHUVjbkMqm9lZEUMZOxqmZ7VRxyEVvL0Fj+4BVeyp64ahYzybwABPpbVr54JP8G/bA6N5y8mMVq++IDr5aWm8p8OaUSijV6eWJ4wlMY+CWU=
  # Phrase
  - secure: sgx2U9/yB84DVejW/ChBwTHzFjT4u9pCZ/VUa2MNBy6RkNUCZbsprD/MTUQbvVHvqN2JTcZhfXqj1+Y5LJIRHsOg6fR3+PZRsYi3oBaylYc5laOGGMCDgCRh+OHBE/k85Ue2YAJ/2MRGE7PiyCJePerwxQKgMLTLvUBoqbor9tGs2Natjmu2px6ZyaQrwvy6mPDz904cxwX8Q8afoJLImYC3SEWUUOQZTdNdUOvO5ILjqO2li/heg6MN/RWeAdN8dfhUtjLf6jTQKhY3RCdq71xzE8O5tnZ5r2sLjsZ9fMiiBEErs5/aGsDk7IR1DTcpHfGF3PkMQUCIyN9j4iHOaclg2lTeYYtT33V+AMduG7jIBlj96GOb0MKwef1YByJ8ImFWpDWjWBCZaHSbVIiFhSy9x0AbNuoN5Zoqq36KL5jpLe2aBySEVJ8XTmM6lxruWC5uy051E0jLIk0pH50mD5LZaPNXyG1rXcMhAWMdklJcUrhlkgrk2f9z4gAh0koG7vs/dP/NpTbNYTnwfn1Iu65HoVW8d+/KjItucd+E9c2A+/GyP6jXRpbaQkxfqbt5eQylBQEHHTOeyvPcdca9UMk/FhdHH70mDBPLaSbJd44JEQ0qyXjT12S/hlAnqqbvq/55gniAaRuZULDXFchSC5JaaoW1cp5G5kdi+J19DcY=
  # DeployServerPort
  - secure: LrI6u8Z65bt9ik11MOf4unxq2aRqz07LTDtvK0D8IwNd/3WKky5ewIM1+sAMeSD041f12ga4GE0BMoKUeQvFnD9EDLri0KCDLmj76YNJdSpidY42LjgNiuiAIQhqm/qWIRsHOoh59QmrdfnNTM357JoPbdSxEkgo94jAMSRMpg9Lv7mYBzWWwiGCm5n1CiWJm4dQb8mr8p2h4iL0lQm3CyLMrfdiR+uk8fkVBQ3IHOGHTsyD78NJLroIcMceRB+dcw1w8c4/73Ii5yg5wkLTP63JyhjbbJdzLg7Sdp2aP7PfxmsxuvekNFQOlmADVHgJtEHAdHsD1BQM1GJ8JeIb7R2jWgKOeLWqrM8UvN80JvjKnhHGG6EacGOpOnjeDc0gPaLPh95ihvEbdh/nv2pb8br0BVlwDGs07ClJN1/6lNZDX6sMT8EkhgVc0YgJDoME7SGb8Y66u831KCIz2oRaoJ7OmorzphFegsTJe0SYSWuKmgiifKC6kLqs2T4ePsbdVc05sGVKVyuYfYThhGojbHAw4cHLL7b6N5I3lHq3/FDEDUnb840tg4tfYM/UW2rI8T5x7Ju/8MtGR1R20YdQx3tRSTNHQRlu7fWhlBrtCbA+dk8+4P7Fj4Ok0LvIU4c2cd9DkoT/sghUi8zfgSU/dtfbOcpp7w91nmG3/g/y0yY=
services:
- docker
before_install:
- openssl aes-256-cbc -K $encrypted_7c37596a1d46_key -iv $encrypted_7c37596a1d46_iv -in deploy_rsa.enc -out /tmp/deploy_rsa -d
- eval "$(ssh-agent -s)"
- chmod 600 /tmp/deploy_rsa
- install -vm700 <(echo "echo $Phrase") "/tmp/ps.sh"
- cat /tmp/deploy_rsa | SSH_ASKPASS="/tmp/ps.sh" DISPLAY=:0 ssh-add -
- install -vm700 <(echo "ConnectionStrings__DefaultConnectionString=$ConnectionString") "docker.env"
script:
- dotnet test F1WM.UnitTests/F1WM.UnitTests.csproj
- docker build -t f1wm:latest F1WM --file F1WM/Dockerfile
- ssh -p $DeployServerPort -o "StrictHostKeyChecking no" $DeployUser@$DeployServer 'mkdir -p build/F1WM/F1WM-context'
- scp -P $DeployServerPort -o "StrictHostKeyChecking no" docker.env docker-compose.yml $DeployUser@$DeployServer:~/build/F1WM
- docker save f1wm:latest | bzip2 | ssh -p $DeployServerPort -o "StrictHostKeyChecking no" $DeployUser@$DeployServer 'bunzip2 | docker load'
- ssh -p $DeployServerPort -o "StrictHostKeyChecking no" $DeployUser@$DeployServer 'docker-compose -f ~/build/F1WM/docker-compose.yml -f ~/docker-compose.yml up -d --no-build'
