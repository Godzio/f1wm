sudo: required
language: csharp
mono: none
dotnet: 2.1.4
env:
  global:
  # ConnectionString
  - secure: AjYqZasuUYTel9zIPlhNqForbIYFTe7Tbx6zCMC57VqNN4LuFPBbPzNmDfTICSk6rclySjuMSep+tVaWUCcNAVrliTbzILge2uTWzphcRaSDHhslb3ng+fQpsnxGYjdgMgJeiYxh2WNruAnqYO8EaFoz6tiZkRUbwzchEbp3cXNeNZtEvXa6ONRsNlWsNDEKoVzcCHEcjZHqdwmX+VR/Z6TwkE4hwGreFl0X9aB7enFOeWKlkYkCuWyzPEockNCIhrzN57RE6kdLd4QRxWOiosyGkrKaTJpkvqsJHaYwzaKXytxYzq2TVRAIq6Kmv4jlAx9ZFefKuaPTkJKR3EvOdLGq4/oPuiguDEPT8eCbiF5bnCwVnNe0jRaYKW/R+YHDQKfrXKY6nWvc+mNwBGp8ZoETWrYpWucsSR1UVjbovPzu9GJWdN+JrwfVae/uZiaWC6lBRLhGd928/tQf5hEKoq/m+mwTJBQzEB0uPcsmgdQbcdumns1FVHRyPyCNdBIq3BZPzq2x9LGofQYvCQhlsMVPuROr2c0xsdoRk4uEkPuj8fXhcscyc4/D320P/l8ly7SuCW5UcmYYZmNIsv1nQ/+XkdRaMdvMvs/7RcT/mXIXAn+di2bwhO9EggY1baT0MXoeDVxyMGIzUDiEC63WiuvkIOQ/cmLLhx3bY0DGQ40=
  # DeployUser
  - secure: nxwFVSuA4n6UzNO2kICwMdRBA62iZE681nc5nrhjoBV1mbObCl8z7pSHkGcRVym4IPJXVvm+QCbNn+qLdbHQNHmYaxBQdXDMhfQjjlHpUfofiWDJmZsNJsAFRR/l0kGmEIR3CvkaLs0EiClguAT6Wj8iuzQVYeeG0yFLbYae01e90XQe4V3SowHxADmRUlmqmOGAMLjVpoN1BJmlSAGyHONkMhGir8V7/1uNP4Qa1PenyZBsWywRiHAELXHh1k9RJXiKC0nXRFSK16SfR1+nqNqUBc6ZKNkzfkaNvaEdH5yRxzk4Gd+0J9ZCNiXLfhGpElgCgGQIbsJDkMx9FfSP0gl/gabku2g1EJC0pfw/U8rM1uc+qccEBtfuLkkuO48Jem6A0uZlcnGKCPT1rnrWAwK5aURmCCIzNAzo0qTS9IX7V22UAFuCedfS3Tyao+CMmeKvqTZcZ4lYifBz5uQbRO5z5GS47pDerjp4HydyurqreZYfQJuwWiwR0UJVthvWi+1n2piouZikiYOrRK+hYpW5e+HvzAn+KU8zUbNcBO/ExsCYdybgCInm4G+JWjjEbroAHl0FeZbOy09Kjcci6R2gMZxmkI3VcxQHxAvNqgAGPlzPL0lag0HZIephAftqqkImlEpnl8llO6eF11gsgHeaGP+PUoYu64DXeR7W0+I=
  # DeployServer
  - secure: KaO80Sr+9Yo79AUu4fia+1yo94WEv0ZRBRMTbewTIQ6xNSX6oT6+cxgao/GjZVryJupObabFcjF8Kd1AYYZzXpSAtNmGg71UeFOsT9B10TgQyPDRujmYf4mYJ9ENY2plh9yd/3pXy+2lrD74DeMY2m/2hFOzdQK8QVGlnxOVLxKyRIhgg0ix9sjBbKhGAox/Zb08Sko9Avcxrb1MG0BeQWI+LW9Eoqh3J2KlTJMywQ7er9f5xSGYSCF5ahBkxTot2RTubNyxVyv1PxAnDn8FBPYCKGwbMSne/AApb7syMVqMhQW4pMHLtMrSuhtkj+4ouPvFHDBa08D1TJnkmOmd9YSvGFnt8xdzaYViWqShHIr6qc/yy/KQutL3oyhZdOT3Xdsswa9RnBsoOzjbGyccBYWuqjvIaGPRGq71W2WrNLR2pqoKNeCfU5nddwFT4kfC0hSlu+bM/Adpu+QNC9y4HdmRKqw3jrjF8xDKEbQBYH6ad7on+bWaPsQgZ2Bca9ARvYa7cvpA0qtU4imfMVbXg55IE+FKOZ18ulps1VvBwoyXQCjgb7mmapjW9o9KYoWPhAbxOCGRbvBHtpQ3wPt6HR9UP9WaKz/BKqLtZ6x540AVOgkME6h31aDkoyHauwP9I1nlYtfa4j83owwmFXplAp54HNI/cK0CMA9lM1PnWMA=
  # Phrase
  - secure: sgx2U9/yB84DVejW/ChBwTHzFjT4u9pCZ/VUa2MNBy6RkNUCZbsprD/MTUQbvVHvqN2JTcZhfXqj1+Y5LJIRHsOg6fR3+PZRsYi3oBaylYc5laOGGMCDgCRh+OHBE/k85Ue2YAJ/2MRGE7PiyCJePerwxQKgMLTLvUBoqbor9tGs2Natjmu2px6ZyaQrwvy6mPDz904cxwX8Q8afoJLImYC3SEWUUOQZTdNdUOvO5ILjqO2li/heg6MN/RWeAdN8dfhUtjLf6jTQKhY3RCdq71xzE8O5tnZ5r2sLjsZ9fMiiBEErs5/aGsDk7IR1DTcpHfGF3PkMQUCIyN9j4iHOaclg2lTeYYtT33V+AMduG7jIBlj96GOb0MKwef1YByJ8ImFWpDWjWBCZaHSbVIiFhSy9x0AbNuoN5Zoqq36KL5jpLe2aBySEVJ8XTmM6lxruWC5uy051E0jLIk0pH50mD5LZaPNXyG1rXcMhAWMdklJcUrhlkgrk2f9z4gAh0koG7vs/dP/NpTbNYTnwfn1Iu65HoVW8d+/KjItucd+E9c2A+/GyP6jXRpbaQkxfqbt5eQylBQEHHTOeyvPcdca9UMk/FhdHH70mDBPLaSbJd44JEQ0qyXjT12S/hlAnqqbvq/55gniAaRuZULDXFchSC5JaaoW1cp5G5kdi+J19DcY=
services:
- docker
before_install:
- openssl aes-256-cbc -K $encrypted_7c37596a1d46_key -iv $encrypted_7c37596a1d46_iv -in deploy_rsa.enc -out /tmp/deploy_rsa -d
- eval "$(ssh-agent -s)"
- chmod 600 /tmp/deploy_rsa
- install -vm700 <(echo "echo $Phrase") "/tmp/ps.sh"
- cat /tmp/deploy_rsa | SSH_ASKPASS="/tmp/ps.sh" DISPLAY=:0 ssh-add -
- install -vm700 <(echo "ConnectionStrings__DefaultConnectionString=$ConnectionString") "docker.env"
script:
- dotnet test F1WM.UnitTests/F1WM.UnitTests.csproj
- docker build -t f1wm:latest F1WM --file F1WM/Dockerfile
- docker build -t proxy:latest F1WM.Proxy --file F1WM.Proxy/Dockerfile
- scp -o "StrictHostKeyChecking no" docker.env docker-compose.yml $DeployUser@$DeployServer:~/build/f1wm/
- docker save f1wm:latest | bzip2 | ssh -o "StrictHostKeyChecking no" $DeployUser@$DeployServer 'bunzip2 | docker load'
- docker save proxy:latest | bzip2 | ssh -o "StrictHostKeyChecking no" $DeployUser@$DeployServer 'bunzip2 | docker load'
- ssh -o "StrictHostKeyChecking no" $DeployUser@$DeployServer 'docker-compose -f ~/build/f1wm/docker-compose.yml up -d'
